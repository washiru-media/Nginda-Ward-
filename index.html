<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nginda Ward MCA Live Poll</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Poppins,Arial,sans-serif;background:linear-gradient(135deg,#000,#062e14);color:#fff;padding:15px}
header{text-align:center;padding:20px;border-bottom:2px solid gold}
header h1{color:gold;margin:0}
#countdown{margin-top:8px;color:#7CFF9B;font-weight:bold}
#barBg{background:#333;border-radius:20px;height:12px;max-width:500px;margin:10px auto}
#bar{height:100%;background:linear-gradient(90deg,#d4af37,#bfa335);width:100%}
#stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:25px}
.stat{background:#111;border:1px solid gold;border-radius:12px;padding:15px;text-align:center}
.stat h2{margin:0;color:gold}
#candidates{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:30px}
.card{background:#111;border:1px solid gold;border-radius:14px;padding:18px;text-align:center;position:relative}
.vote-btn{background:gold;border:none;padding:10px 22px;border-radius:25px;font-weight:bold;cursor:pointer}
.vote-btn:disabled{opacity:.5;cursor:not-allowed}
.bar{height:6px;background:#fff;position:absolute;bottom:0;left:0;border-radius:0 0 14px 14px}
.actions{text-align:center;margin-top:25px}
.actions button{padding:12px 22px;border:none;border-radius:30px;font-weight:bold;margin:6px;cursor:pointer}
.wa{background:#25d366;color:#fff}
.fb{background:#1877f2;color:#fff}
.support{background:gold;color:#000}
.chart-box{background:#fff;border-radius:12px;padding:15px;margin-top:30px}
.admin{margin-top:35px;background:#111;padding:18px;border-radius:14px;border:1px solid gold}
.admin h3{color:gold;margin-top:0}
.admin input,.admin button{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:none}
.admin button{background:#b11226;color:#fff;font-weight:bold}
</style>
</head>

<body>

<header>
  <h1>NGINDA WARD MCA LIVE POLL</h1>
  <p>MARAG√öA CONSTITUENCY</p>
  <div id="countdown"></div>
  <div id="barBg"><div id="bar"></div></div>
</header>

<div id="stats">
  <div class="stat"><h2 id="totalVotes">0</h2><p>Total Votes</p></div>
  <div class="stat"><h2 id="turnout">0%</h2><p>Turnout</p></div>
  <div class="stat"><h2 id="leader">‚Äî</h2><p>Leading</p></div>
</div>

<div id="candidates"></div>
<div id="status" style="text-align:center;margin-top:10px"></div>

<div class="chart-box">
  <canvas id="chart"></canvas>
</div>

<div class="actions">
  <button class="wa" onclick="shareWhatsApp()">WhatsApp</button>
  <button class="fb" onclick="shareFacebook()">Facebook</button>
  <button class="support" onclick="support()">Support</button>
</div>

<div class="admin" id="loginBox">
  <h3>Admin Login</h3>
  <input type="password" id="adminPin" placeholder="Enter Admin PIN">
  <button onclick="login()">Login</button>
  <div id="adminMsg"></div>
</div>

<div class="admin" id="adminPanel" style="display:none">
  <h3>Admin Dashboard</h3>
  <div id="adminInputs"></div>
  <button onclick="addVotes()">Add Votes</button>
  <button onclick="resetVotes()">Reset All Votes</button>
  <button onclick="logout()">Logout</button>
  <div id="adminMsgPanel"></div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCDLp5jthejJ-h8HS653KUzqF9mBrnm2MU",
  authDomain: "nginda-ward-polls.firebaseapp.com",
  databaseURL: "https://nginda-ward-polls-default-rtdb.firebaseio.com",
  projectId: "nginda-ward-polls",
  storageBucket: "nginda-ward-polls.firebasestorage.app",
  messagingSenderId: "379756032408",
  appId: "1:379756032408:web:276a37829322e430a5bbed"
});

const db = firebase.database();
const PATH = "nginda_ward/votes";
const ADMIN_PIN = "2547";
const REGISTERED = 18000;
let pollClosed = false;

/* CANDIDATES */
const candidates=[
 {id:"john",name:"Hon. John MWANGI WA Mpesa"},
 {id:"kinuthia",name:"Hon. Kinuthia Ngunjiri"},
 {id:"zabron",name:"Hon. Zabron Machungu"},
 {id:"thairu",name:"Hon. THAIRU Wang'endo"},
 {id:"kamonde",name:"Hon. Engineer Martin Kamonde"},
 {id:"tadeo",name:"Hon. Tadeo Maina"},
 {id:"stella",name:"Hon. Stella NJERI"},
 {id:"spoilt",name:"Undecided / Spoilt Vote"}
];

candidates.forEach(c=>{
  db.ref(PATH+"/"+c.id).get().then(s=>{
    if(!s.exists()) db.ref(PATH+"/"+c.id).set(0);
  });
});

/* COUNTDOWN */
const DURATION = 72*60*60*1000;
if(!localStorage.pollStart) localStorage.pollStart = Date.now();
const end = +localStorage.pollStart + DURATION;

setInterval(()=>{
  const r = end - Date.now();
  if(r <= 0){
    pollClosed = true;
    document.getElementById("countdown").innerText = "Voting Closed";
    document.getElementById("bar").style.width = "0%";
    return;
  }
  document.getElementById("bar").style.width = (r/DURATION*100)+"%";
  const h=Math.floor(r/36e5),m=Math.floor(r%36e5/6e4),s=Math.floor(r%6e4/1000);
  document.getElementById("countdown").innerText = `Ends in ${h}h ${m}m ${s}s`;
},1000);

/* RENDER */
let chart;
function render(v){
  const total = Object.values(v).reduce((a,b)=>a+b,0) || 1;
  document.getElementById("totalVotes").innerText = total;
  document.getElementById("turnout").innerText = ((total/REGISTERED)*100).toFixed(1)+"%";

  const sorted = [...candidates].sort((a,b)=>(v[b.id]||0)-(v[a.id]||0));
  document.getElementById("leader").innerText = sorted[0].name;

  const box = document.getElementById("candidates");
  box.innerHTML="";
  candidates.forEach(c=>{
    const pct = Math.round((v[c.id]||0)/total*100);
    box.innerHTML += `
      <div class="card">
        <h3>${c.name}</h3>
        <button class="vote-btn" onclick="vote('${c.id}')" ${localStorage.voted||pollClosed?"disabled":""}>Vote</button>
        <div>${v[c.id]||0} votes (${pct}%)</div>
        <div class="bar" style="width:${pct}%"></div>
      </div>`;
  });

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{labels:candidates.map(c=>c.name),datasets:[{data:candidates.map(c=>v[c.id]||0),backgroundColor:"#d4af37"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

/* LIVE */
db.ref(PATH).on("value",s=>render(s.val()||{}));

/* VOTE */
function vote(id){
  if(localStorage.voted || pollClosed) return;
  db.ref(PATH+"/"+id).transaction(v=>(v||0)+1);
  localStorage.voted = "yes";
  document.getElementById("status").innerText = "Thank you for voting!";
}

/* ADMIN */
function renderAdminInputs(){
  adminInputs.innerHTML="";
  candidates.forEach(c=>{
    adminInputs.innerHTML+=`<input type="number" min="0" value="0" id="add-${c.id}" placeholder="Add votes to ${c.name}">`;
  });
}
function login(){
  if(adminPin.value!==ADMIN_PIN){adminMsg.innerText="Invalid PIN";return;}
  loginBox.style.display="none";
  adminPanel.style.display="block";
  renderAdminInputs();
}
function logout(){
  loginBox.style.display="block";
  adminPanel.style.display="none";
}
function addVotes(){
  candidates.forEach(c=>{
    const val=parseInt(document.getElementById("add-"+c.id).value,10)||0;
    if(val>0) db.ref(PATH+"/"+c.id).transaction(v=>(v||0)+val);
  });
  adminMsgPanel.innerText="Votes added successfully";
}
function resetVotes(){
  if(!confirm("Reset all votes?")) return;
  candidates.forEach(c=>db.ref(PATH+"/"+c.id).set(0));
  localStorage.removeItem("voted");
  localStorage.removeItem("pollStart");
  adminMsgPanel.innerText="All votes reset";
}

/* SHARE */
function shareWhatsApp(){window.open("https://wa.me/?text="+encodeURIComponent("Nginda Ward MCA Live Poll "+location.href));}
function shareFacebook(){window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(location.href));}
function support(){alert("Support Media Hub via M-Pesa Till 5827051\n\nGod Bless üôè");}
</script>

</body>
</html>
