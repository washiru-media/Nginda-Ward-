<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nginda Ward MCA Live Poll</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;font-family:Poppins,Arial,sans-serif;
  background:linear-gradient(135deg,#000,#062e14);
  color:#fff;padding:15px
}
header{text-align:center;padding:20px;border-bottom:2px solid gold}
header h1{color:gold;margin:0}
#countdown{
  margin-top:10px;font-weight:900;font-size:1.25rem;
  color:#7CFF9B;animation:pulse 1s infinite alternate
}
@keyframes pulse{
  from{transform:scale(1);color:#7CFF9B}
  to{transform:scale(1.05);color:#00ffcc}
}
#barBg{background:#333;border-radius:20px;height:12px;max-width:500px;margin:10px auto}
#bar{height:100%;background:linear-gradient(90deg,#d4af37,#bfa335);width:100%}
#stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:25px}
.stat{background:#111;border:1px solid gold;border-radius:12px;padding:15px;text-align:center}
.stat h2{margin:0;color:gold}
#candidates{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:30px}
.card{background:#111;border:1px solid gold;border-radius:14px;padding:18px;text-align:center;position:relative}
.vote-btn{background:gold;border:none;padding:10px 22px;border-radius:25px;font-weight:bold;cursor:pointer}
.vote-btn:disabled{opacity:.4;cursor:not-allowed}
.bar{height:6px;background:#fff;position:absolute;bottom:0;left:0;border-radius:0 0 14px 14px}
.chart-box{background:#fff;border-radius:12px;padding:15px;margin-top:30px}
.admin{margin-top:35px;background:#111;padding:18px;border-radius:14px;border:1px solid gold}
.admin h3{color:gold;margin-top:0}
.admin input,.admin select,.admin button{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:none}
.admin button{background:#b11226;color:#fff;font-weight:bold}
.share a{margin:5px;display:inline-block;padding:10px 18px;border-radius:25px;color:#fff;text-decoration:none;cursor:pointer}
.whatsapp{background:#25D366}
.facebook{background:#1877f2}
.support{background:#9c27b0}
</style>
</head>

<body>

<header>
  <h1>NGINDA WARD MCA LIVE POLL</h1>
  <p>VOTE FOR YOUR PREFERRED MCA</p>
  <div id="countdown">Loading‚Ä¶</div>
  <div id="barBg"><div id="bar"></div></div>
</header>

<div id="stats">
  <div class="stat"><h2 id="totalVotes">0</h2><p>Total Votes</p></div>
  <div class="stat"><h2 id="turnout">0%</h2><p>Turnout (15,000)</p></div>
  <div class="stat"><h2 id="leader">‚Äî</h2><p>Leading</p></div>
</div>

<div id="candidates"></div>
<div id="status" style="text-align:center;margin-top:10px"></div>

<div class="share" style="text-align:center">
  <a class="whatsapp" onclick="shareWhatsApp()">WhatsApp</a>
  <a class="facebook" onclick="shareFacebook()">Facebook</a>
  <a class="support" onclick="showSupport()">Support</a>
</div>

<div class="chart-box"><canvas id="chart"></canvas></div>

<div class="admin" id="loginBox">
  <h3>Admin Login</h3>
  <input type="password" id="adminPin" placeholder="Enter Admin PIN">
  <button onclick="login()">Login</button>
  <div id="adminMsg"></div>
</div>

<div class="admin" id="adminPanel" style="display:none">
  <h3>Admin Dashboard</h3>
  <select id="adminCandidate"></select>
  <input type="number" id="adminVotes" placeholder="Votes to add">
  <button onclick="addVotes()">Add Votes</button>
  <button onclick="restartCountdown()">Restart Countdown (48hrs)</button>
  <button onclick="resetVotes()">Reset Votes</button>
  <button onclick="logout()">Logout</button>
  <div id="adminMsgPanel"></div>
</div>

<script>
/* ====== ELEMENT REFERENCES ====== */
const countdown = document.getElementById("countdown");
const bar = document.getElementById("bar");
const totalVotes = document.getElementById("totalVotes");
const turnout = document.getElementById("turnout");
const leader = document.getElementById("leader");
const status = document.getElementById("status");
const adminCandidate = document.getElementById("adminCandidate");
const adminVotes = document.getElementById("adminVotes");

/* ====== FIREBASE ====== */
firebase.initializeApp({
  apiKey:"AIzaSyCDLp5jthejJ-h8HS653KUzqF9mBrnm2MU",
  authDomain:"nginda-ward-polls.firebaseapp.com",
  databaseURL:"https://nginda-ward-polls-default-rtdb.firebaseio.com",
  projectId:"nginda-ward-polls"
});

const db=firebase.database();
const PATH="nginda_ward/votes";
const META="nginda_ward/meta";
const IPPATH="nginda_ward/ips";
const REGISTERED=15000;
const DURATION=48*60*60*1000;
const ADMIN_PIN="2547";

let pollClosed=false;
let pollStart=null;
let userIP=null;
let voteButtonsDisabled=true;

/* ====== FETCH USER IP ====== */
fetch("https://api.ipify.org?format=json")
.then(r=>r.json()).then(d=>{
  userIP=d.ip;
  voteButtonsDisabled=false;
  document.querySelectorAll(".vote-btn").forEach(b=>{
    if(!localStorage.voted) b.disabled=false;
  });
});

/* ====== INIT META ====== */
db.ref(META).get().then(s=>{
  if(!s.exists()){
    db.ref(META).set({start: firebase.database.ServerValue.TIMESTAMP, closed:false});
  }
});

/* ====== COUNTDOWN + AUTO LOCK ====== */
db.ref(META+"/start").on("value", s => pollStart = s.val());
db.ref(META+"/closed").on("value", s => pollClosed = !!s.val());

setInterval(()=>{
  if(!pollStart) return;
  const remain = pollStart + DURATION - Date.now();
  if(remain <= 0){
    pollClosed = true;
    countdown.innerText = "üõë VOTING CLOSED ‚Äî RESULTS LOCKED";
    bar.style.width = "0%";
    db.ref(META+"/closed").set(true);
    return;
  }
  countdown.innerText=`‚è≥ ${Math.floor(remain/36e5)}h ${Math.floor(remain%36e5/6e4)}m ${Math.floor(remain%6e4/1000)}s`;
  bar.style.width=(remain/DURATION*100)+"%";
},1000);

/* ====== CANDIDATES ====== */
const candidates=[
  {id:"john",name:"Hon. John MWANGI WA Mpesa"},
  {id:"kinuthia",name:"Hon. Kinuthia Ngunjiri"},
  {id:"zabron",name:"Hon. Zabron Machungu"},
  {id:"thairu",name:"Hon. THAIRU Wang'endo"},
  {id:"kamonde",name:"Hon. Engineer Martin Kamonde"},
  {id:"tadeo",name:"Hon. Tadeo Maina"},
  {id:"stella",name:"Hon. Stella NJERI"},
  {id:"spoilt",name:"Undecided / Spoilt Vote"}
];

candidates.forEach(c=>{
  db.ref(PATH+"/"+c.id).get().then(s=>{
    if(!s.exists()) db.ref(PATH+"/"+c.id).set(0);
  });
});

let chart;
const candidatesBox = document.getElementById("candidates");
const chartCanvas = document.getElementById("chart");

db.ref(PATH).on("value", s => {
  const v = s.val()||{};
  const total = Object.values(v).reduce((a,b)=>a+b,0);
  totalVotes.innerText = total;
  turnout.innerText = ((total/REGISTERED)*100).toFixed(1)+"%";

  const lead=[...candidates].sort((a,b)=>(v[b.id]||0)-(v[a.id]||0))[0];
  leader.innerHTML=`<b style="color:#fff">${lead.name}</b>`;

  candidatesBox.innerHTML="";
  candidates.forEach(c=>{
    const pct = total ? Math.round((v[c.id]||0)/total*100) : 0;
    candidatesBox.innerHTML+=`
      <div class="card">
        <h3>${c.name}</h3>
        <button class="vote-btn" onclick="vote('${c.id}')"
          ${pollClosed||localStorage.voted||voteButtonsDisabled?"disabled":""}>
          Vote
        </button>
        <div>${v[c.id]||0} votes (${pct}%)</div>
        <div class="bar" style="width:${pct}%"></div>
      </div>`;
  });

  if(chart) chart.destroy();
  chart = new Chart(chartCanvas,{
    type:"bar",
    data:{labels:candidates.map(c=>c.name),datasets:[{data:candidates.map(c=>v[c.id]||0),backgroundColor:"#d4af37"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  adminCandidate.innerHTML = candidates.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
});

/* ====== VOTE FUNCTION ====== */
function vote(id){
  if(pollClosed || localStorage.voted || voteButtonsDisabled){
    alert("Voting is closed.");
    return;
  }
  const ipKey = userIP.replace(/\./g,"_");
  db.ref(IPPATH+"/"+ipKey).get().then(s=>{
    if(s.exists()){alert("Already voted");return;}
    db.ref(PATH+"/"+id).transaction(v=>(v||0)+1);
    db.ref(IPPATH+"/"+ipKey).set(true);
    localStorage.voted="yes";
    status.innerText="‚úÖ Thank you for voting!";
  });
}

/* ====== ADMIN ====== */
function login(){
  if(adminPin.value!==ADMIN_PIN){adminMsg.innerText="Invalid PIN"; return;}
  loginBox.style.display="none";
  adminPanel.style.display="block";
}

function addVotes(){
  if(pollClosed){alert("Results are locked"); return;}
  const id = adminCandidate.value;
  const v = parseInt(adminVotes.value)||0;
  if(v<=0){alert("Enter valid vote count"); return;}
  db.ref(PATH+"/"+id).transaction(x=>(x||0)+v);
}

function restartCountdown(){
  if(pollClosed){alert("Poll already closed"); return;}
  db.ref(META).set({start: firebase.database.ServerValue.TIMESTAMP, closed:false});
}

function resetVotes(){
  if(pollClosed){alert("Results are locked"); return;}
  if(confirm("Reset all votes?")){
    db.ref(PATH).set({});
    db.ref(IPPATH).set({});
    localStorage.clear();
  }
}

function logout(){loginBox.style.display="block"; adminPanel.style.display="none";}

/* ====== SUPPORT ====== */
function showSupport(){
  alert(`Support Media Hub via MPesa Till 5827051
or 0724253280
FRANCIS MWANGI KIMANI üôè`);
}

/* ====== SHARE ====== */
function shareWhatsApp(){window.open(`https://wa.me/?text=${encodeURIComponent(document.title+" "+location.href)}`);}
function shareFacebook(){window.open(`https://www.facebook.com/sharer/sharer.php?u=${location.href}`);}
</script>

</body>
</html>
